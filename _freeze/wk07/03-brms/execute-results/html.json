{
  "hash": "788a05eedfea8f2213592760a67a37a2",
  "result": {
    "engine": "knitr",
    "markdown": "# \\{brms\\}\n\n\n\n\n\n\n\n\n\nIn most cases, we do not have to write our own Stan code, because the {brms} package can do that for us. The `brm()` function in the {brms} takes `glm()`-like arguments, and writes accurate and fast Stan code. If `brm()` works for your application, you should much prefer it to writing your on Stan models. It will (probably) be faster and is less like to have errors.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load packages\nlibrary(brms)\n```\n:::\n\n\n\n\n{brms} offers very flexible options for specifying your models and works with {marginaleffects}. We can use it for almost any application, though for simple `lm()` or `glm()` fits, it isn't needed.\n\nSee `?brms::brm` for the details. There are numerous tutorials available for specific models.\n\n## The `turnout` example\n\nHere's the syntax for our ususal logistic regression model.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load only the turnout data frame and hard-code rescaled variables\nturnout <- ZeligData::turnout  |>\n  mutate(across(age:income, arm::rescale, .names = \"rs_{.col}\"))\n\n# build model frame and design matrices\nf  <- vote ~ rs_age + rs_educate + rs_income + race\n\n# fit model with glm()\nfit_glm <- glm(f, data = turnout, family = binomial)\n\n# fit model with brm()\nfit_brm_rstan <- brm(f, data = turnout, family = bernoulli, \n           chains = 10, cores = 10)\n\n# fit model with brm() via cmdstan!\nfit_brm_cmdstanr <- brm(f, data = turnout, family = bernoulli, \n           chains = 10, cores = 10, \n           backend = \"cmdstanr\")\n```\n:::\n\n\n\n`glm()` and `brm()` obtain the same estimates.^[The two are not mathematically equal, but they are very close in practice. Outside of cases where maximum likelihood fails, it is rare that a Bayesian estimate or interval differs from the ML estimate or interval.]\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(modelsummary)\n\nnormalize_terms <- function(x) {\n  x <- sub(\"^b_\", \"\", x)  # brms to glm names\n  x <- ifelse(x == \"(Intercept)\", \"Intercept\", x)  # unify intercept\n  x\n}\n\nmodelsummary(\n  list(\"glm()\" = fit_glm, \"brm(); rstan\" = fit_brm_rstan, \"brm(); cmdstanr\" = fit_brm_cmdstanr),\n  coef_rename = normalize_terms, \n  gof_map = NULL\n)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<!-- preamble start -->\n\n    <script>\n\n      function styleCell_91jk212huh72cna2rgun(i, j, css_id) {\n          var table = document.getElementById(\"tinytable_91jk212huh72cna2rgun\");\n          var cell = table.querySelector(`[data-row=\"${i}\"][data-col=\"${j}\"]`);\n          if (cell) {\n              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);\n              cell.classList.add(css_id);\n          } else {\n              console.warn(`Cell at (${i}, ${j}) not found.`);\n          }\n      }\n      function spanCell_91jk212huh72cna2rgun(i, j, rowspan, colspan) {\n        var table = document.getElementById(\"tinytable_91jk212huh72cna2rgun\");\n        const targetCell = table.querySelector(`[data-row=\"${i}\"][data-col=\"${j}\"]`);\n        if (!targetCell) {\n          console.warn(`Cell at (${i}, ${j}) not found.`);\n        }\n\n        // Get all cells that need to be removed\n        const cellsToRemove = [];\n        for (let r = 0; r < rowspan; r++) {\n          for (let c = 0; c < colspan; c++) {\n            if (r === 0 && c === 0) continue; // Skip the target cell\n            const cell = table.querySelector(`[data-row=\"${i + r}\"][data-col=\"${j + c}\"]`);\n            if (cell) {\n              cellsToRemove.push(cell);\n            }\n          }\n        }\n\n        // Remove all cells\n        cellsToRemove.forEach(cell => cell.remove());\n\n        // Set rowspan and colspan of the target cell if it exists\n        if (targetCell) {\n          targetCell.rowSpan = rowspan;\n          targetCell.colSpan = colspan;\n        }\n      }\n      // tinytable span after\n      window.addEventListener('load', function () {\n          var cellsToStyle = [\n            // tinytable style arrays after\n          { positions: [ { i: '21', j: 2 }, { i: '21', j: 1 }, { i: '21', j: 3 },  ], css_id: 'tinytable_css_9jmbfmbe1tlmdga9msu7',}, \n          { positions: [ { i: '10', j: 3 }, { i: '10', j: 2 }, { i: '10', j: 1 },  ], css_id: 'tinytable_css_50fb67hym2r2t3s6koye',}, \n          { positions: [ { i: '2', j: 1 }, { i: '3', j: 1 }, { i: '4', j: 1 }, { i: '6', j: 1 }, { i: '7', j: 1 }, { i: '8', j: 1 }, { i: '1', j: 1 }, { i: '1', j: 2 }, { i: '11', j: 1 }, { i: '12', j: 1 }, { i: '13', j: 1 }, { i: '14', j: 1 }, { i: '15', j: 1 }, { i: '16', j: 1 }, { i: '17', j: 1 }, { i: '5', j: 1 }, { i: '19', j: 1 }, { i: '20', j: 1 }, { i: '12', j: 2 }, { i: '9', j: 1 }, { i: '14', j: 2 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '8', j: 2 }, { i: '18', j: 1 }, { i: '1', j: 3 }, { i: '11', j: 2 }, { i: '3', j: 3 }, { i: '13', j: 2 }, { i: '5', j: 3 }, { i: '15', j: 2 }, { i: '16', j: 2 }, { i: '17', j: 2 }, { i: '18', j: 2 }, { i: '19', j: 2 }, { i: '20', j: 2 }, { i: '12', j: 3 }, { i: '9', j: 2 }, { i: '14', j: 3 }, { i: '2', j: 3 }, { i: '16', j: 3 }, { i: '4', j: 3 }, { i: '18', j: 3 }, { i: '6', j: 3 }, { i: '7', j: 3 }, { i: '8', j: 3 }, { i: '9', j: 3 }, { i: '11', j: 3 }, { i: '20', j: 3 }, { i: '13', j: 3 }, { i: '15', j: 3 }, { i: '17', j: 3 }, { i: '19', j: 3 },  ], css_id: 'tinytable_css_ew168gevrp2nzo3uaolv',}, \n          { positions: [ { i: '0', j: 1 }, { i: '0', j: 3 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_nj9h8zognhbza4sakdn7',}, \n          { positions: [ { i: '21', j: 0 },  ], css_id: 'tinytable_css_8989fyojdl58euw7dkpa',}, \n          { positions: [ { i: '10', j: 0 },  ], css_id: 'tinytable_css_22oo6794j3eel39voppj',}, \n          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '7', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 }, { i: '14', j: 0 }, { i: '11', j: 0 }, { i: '12', j: 0 }, { i: '13', j: 0 }, { i: '18', j: 0 }, { i: '15', j: 0 }, { i: '16', j: 0 }, { i: '17', j: 0 }, { i: '19', j: 0 }, { i: '20', j: 0 },  ], css_id: 'tinytable_css_wz3qt469fs4oz6yfpvdu',}, \n          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_3wskrmzbp1cwxntak9dw',}, \n          ];\n\n          // Loop over the arrays to style the cells\n          cellsToStyle.forEach(function (group) {\n              group.positions.forEach(function (cell) {\n                  styleCell_91jk212huh72cna2rgun(cell.i, cell.j, group.css_id);\n              });\n          });\n      });\n    </script>\n\n    <style>\n      /* tinytable css entries after */\n      .table td.tinytable_css_9jmbfmbe1tlmdga9msu7, .table th.tinytable_css_9jmbfmbe1tlmdga9msu7 { text-align: center; border-bottom: solid #d3d8dc 0.1em; }\n      .table td.tinytable_css_50fb67hym2r2t3s6koye, .table th.tinytable_css_50fb67hym2r2t3s6koye { text-align: center; border-bottom: solid black 0.05em; }\n      .table td.tinytable_css_ew168gevrp2nzo3uaolv, .table th.tinytable_css_ew168gevrp2nzo3uaolv { text-align: center; }\n      .table td.tinytable_css_nj9h8zognhbza4sakdn7, .table th.tinytable_css_nj9h8zognhbza4sakdn7 { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }\n      .table td.tinytable_css_8989fyojdl58euw7dkpa, .table th.tinytable_css_8989fyojdl58euw7dkpa { text-align: left; border-bottom: solid #d3d8dc 0.1em; }\n      .table td.tinytable_css_22oo6794j3eel39voppj, .table th.tinytable_css_22oo6794j3eel39voppj { text-align: left; border-bottom: solid black 0.05em; }\n      .table td.tinytable_css_wz3qt469fs4oz6yfpvdu, .table th.tinytable_css_wz3qt469fs4oz6yfpvdu { text-align: left; }\n      .table td.tinytable_css_3wskrmzbp1cwxntak9dw, .table th.tinytable_css_3wskrmzbp1cwxntak9dw { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }\n    </style>\n    <div class=\"container\">\n      <table class=\"table table-borderless\" id=\"tinytable_91jk212huh72cna2rgun\" style=\"width: auto; margin-left: auto; margin-right: auto;\" data-quarto-disable-processing='true'>\n        <thead>\n        \n              <tr>\n                <th scope=\"col\" data-row=\"0\" data-col=\"0\"> </th>\n                <th scope=\"col\" data-row=\"0\" data-col=\"1\">glm()</th>\n                <th scope=\"col\" data-row=\"0\" data-col=\"2\">brm(); rstan</th>\n                <th scope=\"col\" data-row=\"0\" data-col=\"3\">brm(); cmdstanr</th>\n              </tr>\n        </thead>\n        \n        <tbody>\n                <tr>\n                  <td data-row=\"1\" data-col=\"0\">Intercept</td>\n                  <td data-row=\"1\" data-col=\"1\">1.058</td>\n                  <td data-row=\"1\" data-col=\"2\">1.062</td>\n                  <td data-row=\"1\" data-col=\"3\">1.062</td>\n                </tr>\n                <tr>\n                  <td data-row=\"2\" data-col=\"0\"></td>\n                  <td data-row=\"2\" data-col=\"1\">(0.140)</td>\n                  <td data-row=\"2\" data-col=\"2\"></td>\n                  <td data-row=\"2\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"3\" data-col=\"0\">rs_age</td>\n                  <td data-row=\"3\" data-col=\"1\">0.993</td>\n                  <td data-row=\"3\" data-col=\"2\">0.996</td>\n                  <td data-row=\"3\" data-col=\"3\">0.997</td>\n                </tr>\n                <tr>\n                  <td data-row=\"4\" data-col=\"0\"></td>\n                  <td data-row=\"4\" data-col=\"1\">(0.121)</td>\n                  <td data-row=\"4\" data-col=\"2\"></td>\n                  <td data-row=\"4\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"5\" data-col=\"0\">rs_educate</td>\n                  <td data-row=\"5\" data-col=\"1\">1.184</td>\n                  <td data-row=\"5\" data-col=\"2\">1.188</td>\n                  <td data-row=\"5\" data-col=\"3\">1.186</td>\n                </tr>\n                <tr>\n                  <td data-row=\"6\" data-col=\"0\"></td>\n                  <td data-row=\"6\" data-col=\"1\">(0.137)</td>\n                  <td data-row=\"6\" data-col=\"2\"></td>\n                  <td data-row=\"6\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"7\" data-col=\"0\">rs_income</td>\n                  <td data-row=\"7\" data-col=\"1\">1.001</td>\n                  <td data-row=\"7\" data-col=\"2\">1.002</td>\n                  <td data-row=\"7\" data-col=\"3\">1.004</td>\n                </tr>\n                <tr>\n                  <td data-row=\"8\" data-col=\"0\"></td>\n                  <td data-row=\"8\" data-col=\"1\">(0.154)</td>\n                  <td data-row=\"8\" data-col=\"2\"></td>\n                  <td data-row=\"8\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"9\" data-col=\"0\">racewhite</td>\n                  <td data-row=\"9\" data-col=\"1\">0.251</td>\n                  <td data-row=\"9\" data-col=\"2\">0.248</td>\n                  <td data-row=\"9\" data-col=\"3\">0.251</td>\n                </tr>\n                <tr>\n                  <td data-row=\"10\" data-col=\"0\"></td>\n                  <td data-row=\"10\" data-col=\"1\">(0.146)</td>\n                  <td data-row=\"10\" data-col=\"2\"></td>\n                  <td data-row=\"10\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"11\" data-col=\"0\">Num.Obs.</td>\n                  <td data-row=\"11\" data-col=\"1\">2000</td>\n                  <td data-row=\"11\" data-col=\"2\">2000</td>\n                  <td data-row=\"11\" data-col=\"3\">2000</td>\n                </tr>\n                <tr>\n                  <td data-row=\"12\" data-col=\"0\">R2</td>\n                  <td data-row=\"12\" data-col=\"1\"></td>\n                  <td data-row=\"12\" data-col=\"2\">0.119</td>\n                  <td data-row=\"12\" data-col=\"3\">0.119</td>\n                </tr>\n                <tr>\n                  <td data-row=\"13\" data-col=\"0\">AIC</td>\n                  <td data-row=\"13\" data-col=\"1\">2034.0</td>\n                  <td data-row=\"13\" data-col=\"2\"></td>\n                  <td data-row=\"13\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"14\" data-col=\"0\">BIC</td>\n                  <td data-row=\"14\" data-col=\"1\">2062.0</td>\n                  <td data-row=\"14\" data-col=\"2\"></td>\n                  <td data-row=\"14\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"15\" data-col=\"0\">Log.Lik.</td>\n                  <td data-row=\"15\" data-col=\"1\">-1011.991</td>\n                  <td data-row=\"15\" data-col=\"2\"></td>\n                  <td data-row=\"15\" data-col=\"3\"></td>\n                </tr>\n                <tr>\n                  <td data-row=\"16\" data-col=\"0\">ELPD</td>\n                  <td data-row=\"16\" data-col=\"1\"></td>\n                  <td data-row=\"16\" data-col=\"2\">-1017.1</td>\n                  <td data-row=\"16\" data-col=\"3\">-1017.2</td>\n                </tr>\n                <tr>\n                  <td data-row=\"17\" data-col=\"0\">ELPD s.e.</td>\n                  <td data-row=\"17\" data-col=\"1\"></td>\n                  <td data-row=\"17\" data-col=\"2\">23.0</td>\n                  <td data-row=\"17\" data-col=\"3\">23.0</td>\n                </tr>\n                <tr>\n                  <td data-row=\"18\" data-col=\"0\">LOOIC</td>\n                  <td data-row=\"18\" data-col=\"1\"></td>\n                  <td data-row=\"18\" data-col=\"2\">2034.2</td>\n                  <td data-row=\"18\" data-col=\"3\">2034.5</td>\n                </tr>\n                <tr>\n                  <td data-row=\"19\" data-col=\"0\">LOOIC s.e.</td>\n                  <td data-row=\"19\" data-col=\"1\"></td>\n                  <td data-row=\"19\" data-col=\"2\">46.1</td>\n                  <td data-row=\"19\" data-col=\"3\">46.0</td>\n                </tr>\n                <tr>\n                  <td data-row=\"20\" data-col=\"0\">WAIC</td>\n                  <td data-row=\"20\" data-col=\"1\"></td>\n                  <td data-row=\"20\" data-col=\"2\">2034.2</td>\n                  <td data-row=\"20\" data-col=\"3\">2034.5</td>\n                </tr>\n                <tr>\n                  <td data-row=\"21\" data-col=\"0\">RMSE</td>\n                  <td data-row=\"21\" data-col=\"1\">0.41</td>\n                  <td data-row=\"21\" data-col=\"2\">0.41</td>\n                  <td data-row=\"21\" data-col=\"3\">0.41</td>\n                </tr>\n        </tbody>\n      </table>\n    </div>\n<!-- hack to avoid NA insertion in last line -->\n```\n\n:::\n:::\n\n\n\n\nAnd {brms} plays very nicely with {marginaleffects}.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(marginaleffects)\n\n# compute first different\ncomparisons(fit_brm_cmdstanr, variables = list(rs_age = c(-0.5, 0.5)), \n            newdata = datagrid(grid_type = \"mean_or_mode\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate 2.5 % 97.5 %\n    0.167 0.128  0.205\n\nTerm: rs_age\nType: response\nComparison: 0.5 - -0.5\n```\n\n\n:::\n\n```{.r .cell-code}\n# compute and plot expected values (i.e., predicted probabilities)\np <- predictions(fit_brm_cmdstanr, variables = list(rs_age = seq(-1, 1, by = 0.1)), \n            newdata = datagrid(grid_type = \"mean_or_mode\"))\nggplot(p, aes(x = rs_age, y = estimate, ymin = conf.low, ymax = conf.high)) + \n  geom_ribbon(fill = \"grey\") + \n  geom_line()\n```\n\n::: {.cell-output-display}\n![](03-brms_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n## The flexibility of MCMC and `brm()`\n\n### Modeling \"smooth\" relationships\n\nTo illustrate the power of MCMC and `brm()`, we can imagine fitting a smooth curve for age. The details are not important for now, but this isn't an easy task in our usual framework. But it's straightfoward with Bayesian MCMC via `brm()`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# smooth relationship between age and voting--notice the s()\nf  <- vote ~ s(rs_age) + rs_educate + rs_income + race\nsmooth_fit <- brm(f, data = turnout, family = bernoulli, \n           chains = 10, cores = 10, \n           backend = \"cmdstanr\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# compute and plot expected values (i.e., predicted probabilities)\np <- predictions(smooth_fit, variables = list(rs_age = seq(-1, 1, by = 0.1)), \n            newdata = datagrid(grid_type = \"mean_or_mode\"))\nggplot(p, aes(x = rs_age, y = estimate, ymin = conf.low, ymax = conf.high)) + \n  geom_ribbon(fill = \"grey\") + \n  geom_line()\n```\n\n::: {.cell-output-display}\n![](03-brms_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n### Awkwardly scaled variables\n\nAlso, `brm()` has no trouble with the variables on their original scales. The original scales poses a insurmountable hurdle for our `metrop()` sampler.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# smooth relationship between age and voting--notice the s()\nf  <- vote ~ s(age) + educate + income + race\nsmooth_fit <- brm(f, data = turnout, family = bernoulli, \n           chains = 10, cores = 10, \n           backend = \"cmdstanr\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# compute and plot expected values (i.e., predicted probabilities)\np <- predictions(smooth_fit, variables = list(age = seq(18, 90, by = 1)), \n            newdata = datagrid(grid_type = \"mean_or_mode\"))\nggplot(p, aes(x = age, y = estimate, ymin = conf.low, ymax = conf.high)) + \n  geom_ribbon(fill = \"grey\") + \n  geom_line()\n```\n\n::: {.cell-output-display}\n![](03-brms_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}