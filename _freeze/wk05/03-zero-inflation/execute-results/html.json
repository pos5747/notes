{
  "hash": "99895296a91061eb751eaf4c12b5768f",
  "result": {
    "engine": "knitr",
    "markdown": "# Zero Inflation\n\n\n\n\n\n\n\n\n\n\n\n\nIn a prior chapter, we used a negative binomial regression to model the number of enforcement operations in Holland's (2015) data. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# load data\nsant <- crdata::holland2015 |>\n  filter(city == \"santiago\")\n\n# formula\nf <- operations ~ lower + vendors + budget + population\n\n# nb regression\nnb_fit <- MASS::glm.nb(\n  formula = f,\n  data = sant\n)\n\n# simulate from predictive distribution\nnb_sims <- simulate(nb_fit, nsim = 5)\n\n# plot\nbind_cols(sant, nb_sims) |>\n  pivot_longer(cols = c(operations, starts_with(\"sim_\"))) |>\n  separate(name, into = c(\"type\", \"sim_id\"), sep = \"_\", remove = FALSE) |>\n  ggplot(aes(x = value)) + \n  facet_wrap(vars(name)) +\n  geom_histogram(center = 0, binwidth = 1)\n```\n\n::: {.cell-output-display}\n![](03-zero-inflation_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\nNotice that the negative binomial model as too many large values. I have a subtle intuition that the negative binomial is struggling to simultaneously capture the (1) mean, (2) the large spike at zero, and (3) the relative absence of large values.\n\nTo address this, we might add a component to the model to inflated the number of zeros relative to the usual negative binomial distribution. \n\nIt is fairly common for count data to have lots of zeros. We can imagine this substantively by thinking of two different processes. One process determines whether the observation is at risk of any events *at all*. Another process determines the number of events, which might still be zero.^[This \"two process\" motivation is simply a story to motivate the model---don't take it too literally, especially when interpreting parameter estimates.]\n\nWe can model as excess of zeros using a zero-inflation model. A zero-inflation model has two steps. In the first step, we have a logit model that determines whether the observation will equal zero or be a draw from some distribution.\n\n## Negative Binomial case\n\nLet's first consider zero-inflation in the negative binomial. How could we model an excess of zeros for an NB baseline distribution?\n\n### pmf\n\nLet $f(y_i; \\mu_i, \\theta)$ denote the pmf of a negative binomial distribution with mean $\\mu_i$ and dispersion $\\theta$.^[This the `nbinom2` parameterization with overdispersion parameter $\\theta$, where $\\text{Var}(Y_i) = \\mu_i + \\mu_i^2/\\theta$).] We assume that observation $i$ comes from\n\n$$\ny_i \\sim \n\\begin{cases}\n0 & \\text{with probability } \\pi_i, \\\\\n\\text{NB}(\\mu_i, \\theta) & \\text{with probability } 1 - \\pi_i,\n\\end{cases}\n$$\n\nwhere $\\pi_i \\in (0,1)$ is the probability of a *structural zero*. The remaining values follow the usual negative binomial distribution.^[Important note: even in an observation is not a structure zero, it still might equal zero, because the negative binomial has positive probability on zero as well. So there are *two ways* to get a zero.]\n\nEquivalently, the pmf of $y_i$ can be written as\n\n$$\nf(y_i; \\pi_i, \\mu_i, \\theta) = \n\\begin{cases}\n\\pi_i + (1 - \\pi_i) f(0; \\mu_i, \\theta) & \\text{if } y_i = 0 \\\\[6pt]\n(1 - \\pi_i) f(y_i; \\mu_i, \\theta) & \\text{if } y_i \\neq 0\n\\end{cases}.\n$$\n\n### Likelihood\n\nCreate an indicator variable $z_i = \\mathbf{1}(y_i = 0)$ that equals one if $y_i = 0$ and zero otherwise. Then for independent $y_1, \\dots, y_n$, the likelihood is\n\n$$\nL(\\pi, \\mu, \\theta) = \n\\prod_{i=1}^n \\Bigg\\{\n\\big[ \\pi_i + (1 - \\pi_i) f(0; \\mu_i, \\theta) \\big]^{z_i}\n\\cdot\n\\big[ (1 - \\pi_i) f(y_i; \\mu_i, \\theta) \\big]^{1 - z_i}\n\\Bigg\\}.\n$$\n\n### Log-Likelihood\n\nTaking logs, the log-likelihood is\n\n$$\n\\ell(\\pi, \\mu, \\theta) =\n\\sum_{i=1}^n\n\\Bigg\\{\nz_i \\cdot \\log\\big( \\pi_i + (1 - \\pi_i) f(0; \\mu_i, \\theta) \\big)\n+\n(1 - z_i) \\cdot \\big[ \\log(1 - \\pi_i) + \\log f(y_i; \\mu_i, \\theta) \\big]\n\\Bigg\\}.\n$$\n\nWe can imagine that $\\pi_i = \\text{logit}^{-1}(Z\\gamma)$ and $\\mu_i = \\exp(X\\beta)$, with $\\theta$ modeled as in a standard negative binomial regression.\n\n### In R\n\nWe can fit the zero-inflated negative binomial using the `glmmTMB()` function in R. Create the design matrix X with `formula` (for $\\mu_i = \\exp (X\\beta)$) and the design matrix `Z` with `ziformula` (for $\\pi_i = \\text{logit}^{-1} (Z\\gamma)$). The family `nbinom2` specifies the negative binomial with variance $\\mu + \\mu^2/\\theta$ (which matrix `MASS::glm.nb()`)\n\n- `glmmTMB()` has a `simulate()` method to simulate from the predictive distribution.\n- `glmTMB()` works well with {marginaleffects}.\n\n#### Constant $\\pi$\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# formula\nf <- operations ~ lower + vendors + budget + population\n\n# zinb regression\nlibrary(glmmTMB)\nzinb_fit <- glmmTMB(\n  formula = f,  # usual nb part\n  ziformula = ~ 1, # zero-inflation (logit) w/ intercept only\n  family = nbinom2,  # \"theta parameterization\"\n  data = sant\n)\n```\n:::\n\n\n\n\n\nThen we can use `simulate()` to simulate from the predictive distribution and plot it in the usual way.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# simulate from predictive distribution\nzinb_sims <- simulate(zinb_fit, nsim = 5)\n\n# plot\nbind_cols(sant, zinb_sims) |>\n  pivot_longer(cols = c(operations, starts_with(\"sim_\"))) |>\n  separate(name, into = c(\"type\", \"sim_id\"), sep = \"_\", remove = FALSE) |>\n  ggplot(aes(x = value)) + \n  facet_wrap(vars(name)) +\n  geom_histogram(center = 0, binwidth = 1)\n```\n\n::: {.cell-output-display}\n![](03-zero-inflation_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n#### $\\pi_i = \\text{logit}^{-1}(X\\beta)$\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# formulas\nf <- operations ~ lower + vendors + budget + population\nzi_f <-  ~ lower + vendors + budget + population\n\n# zinb regression\nzinb2_fit <- glmmTMB(\n  formula = f,  \n  ziformula = zi_f, # ðŸ†• model zi using covariates\n  family = nbinom2,  \n  data = sant\n)\n```\n:::\n\n\n\n\n\nThen we can use `simulate()` to simulate from the predictive distribution and plot it in the usual way.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# simulate from predictive distribution\nzinb2_sims <- simulate(zinb2_fit, nsim = 5)\n\n# plot\nbind_cols(sant, zinb2_sims) |>\n  pivot_longer(cols = c(operations, starts_with(\"sim_\"))) |>\n  separate(name, into = c(\"type\", \"sim_id\"), sep = \"_\", remove = FALSE) |>\n  ggplot(aes(x = value)) + \n  facet_wrap(vars(name)) +\n  geom_histogram(center = 0, binwidth = 1)\n```\n\n::: {.cell-output-display}\n![](03-zero-inflation_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\nThe predictive distributions for both ZINB models look much better. Because the zero-inflated part of the model handles the spike at zero, the negative binomial part of the model can better match the remainder of the distribution.\n\n### IC\n\nThe BIC likes the ZINB model with covariates best, and the model with*out* zero-inflation is a close second.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nBIC(nb_fit, zinb_fit, zinb2_fit) |>\n  mutate(diff_min = BIC - min(BIC),\n         post_prob = exp(-0.5*diff_min)/sum(exp(-0.5*diff_min)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          df      BIC  diff_min  post_prob\nnb_fit     6 142.8430 0.5379471 0.40320644\nzinb_fit   7 146.3694 4.0643077 0.06914933\nzinb2_fit 11 142.3051 0.0000000 0.52764423\n```\n\n\n:::\n:::\n\n\n\n\n\nThe AIC likes the ZINB model with covariates best and the other two models aren't particularly close.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(nb_fit, zinb_fit, zinb2_fit) |>\n  mutate(diff_min = AIC - min(AIC),\n         akaike_weights = exp(-0.5*diff_min)/sum(exp(-0.5*diff_min)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          df      AIC diff_min akaike_weights\nnb_fit     6 133.6848  8.16975    0.016446724\nzinb_fit   7 135.6848 10.16975    0.006050412\nzinb2_fit 11 125.5151  0.00000    0.977502864\n```\n\n\n:::\n:::\n\n\n\n\n\n### \\{marginaleffects\\}\n\nWe can use the `avg_comparisons()` function to compute the average first difference as we move `lower` from its min to its max, averaging across the observed values of all the other covariates.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# compute avg. fd\navg_comparisons(nb_fit, variables = list(lower = \"minmax\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error      z Pr(>|z|)   S 2.5 % 97.5 %\n      -13       15.4 -0.845    0.398 1.3 -43.1   17.1\n\nTerm: lower\nType: response\nComparison: Max - Min\n```\n\n\n:::\n\n```{.r .cell-code}\navg_comparisons(zinb_fit, variables = list(lower = \"minmax\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error      z Pr(>|z|)   S 2.5 % 97.5 %\n      -13         15 -0.867    0.386 1.4 -42.3   16.4\n\nTerm: lower\nType: response\nComparison: Max - Min\n```\n\n\n:::\n\n```{.r .cell-code}\navg_comparisons(zinb2_fit, variables = list(lower = \"minmax\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error      z Pr(>|z|)   S 2.5 % 97.5 %\n    -5.72       6.32 -0.905    0.365 1.5 -18.1   6.67\n\nTerm: lower\nType: response\nComparison: Max - Min\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# compute avg. fd\nnb_fd <- avg_comparisons(nb_fit, variables = list(lower = \"minmax\"))\nzinb_fd <- avg_comparisons(zinb_fit, variables = list(lower = \"minmax\"))\nzinb2_fd <- avg_comparisons(zinb2_fit, variables = list(lower = \"minmax\"))\n\n# plot\nlist(\"NB\" = nb_fd, \n     \"ZINB; no covariates\" = zinb_fd,\n     \"ZINB; w/ covariates\" = zinb2_fd) |>\n  bind_rows(.id = \"model\") |>\n  ggplot(aes(x = estimate, xmin = conf.low, xmax = conf.high,\n             y = model)) + \n  geom_errorbarh() + \n  geom_point()\n```\n\n::: {.cell-output-display}\n![](03-zero-inflation_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n::: callout-warning\nIt's worth pointing out that the `sant` dataset only has 34 observations and the zero-inflated negative binomial model with covariates has 11 parameters. This is small enough that we might worry about asymptotic approximations.\n:::\n\n## Poisson case\n\nWe could similarly use a zero-inflated Poisson. It follows the same logic. But it seems very usual in practice to have zero-inflation without over-dispersion, so I'll just mention the possibility.\n\n## Other cases\n\nWe can easily extend this logic to other distributions as well. For example, we might imagine that some variables, like trade (in dollars) between two countries, might have a continuous distribution with a spike at zero. In this case, we could imagine a zero-inflated normal, for example.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}